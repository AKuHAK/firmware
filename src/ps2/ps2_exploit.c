#include "ps2_exploit.h"

#include <debug.h>
#include <inttypes.h>
#include <stddef.h>
#include <stdint.h>
#include <stdio.h>
#include <string.h>

#include "flashmap.h"
#include "hardware/flash.h"
#include "hardware/regs/addressmap.h"
#include "hardware/sync.h"
#include "pico/time.h"
#include "pico/types.h"
#include "sd.h"

#define CARD_SIZE (8 * 1024 * 1024)

bool card_available = false;
static exploit_cb_t exploit_cb;
static uint64_t exploitprog_start;
static size_t exploitprog_pos;
static int exploitprog_wr;

void ps2_exploit_init(void) {
    if ((*(char *)(FLASH_OFF_PS2EXP + XIP_BASE)) != 0xFF) {
        card_available = true;
        printf("Using exploit card.\n");
    }
}

char *ps2_exploit_error(int rc) {
    switch (rc) {
        case 0: return "No error";
        case PS2_EXPLOIT_DEPLOY_NOFILE: return "exploit.bin not\nfound\n";
        case PS2_EXPLOIT_DEPLOY_OPEN: return "Cannot open\nexploit.bin\n";
        case PS2_EXPLOIT_DEPLOY_READ: return "Cannot read\nexploit.bin\n";
        default: return "Unknown error";
    }
}

int ps2_exploit_deploy(void) {
    uint8_t buf[256] = {0};

    if (!sd_exists("exploit.bin"))
        return PS2_EXPLOIT_DEPLOY_NOFILE;

    int fd = sd_open("exploit.bin", O_RDONLY);
    if (fd < 0)
        return PS2_EXPLOIT_DEPLOY_OPEN;

    if (sd_filesize(fd) == CARD_SIZE) {
        size_t erase_offset = FLASH_OFF_PS2EXP;
        uint32_t offset = FLASH_OFF_PS2EXP;

        exploitprog_start = time_us_64();
        exploitprog_wr = 0;

        while (erase_offset < FLASH_OFF_PS2EXP + CARD_SIZE) {
            uint32_t ints = save_and_disable_interrupts();
            flash_range_erase(erase_offset, 65536);

            restore_interrupts(ints);

            erase_offset += 65536;

            exploitprog_pos = (erase_offset - FLASH_OFF_PS2EXP) / 2;

            if (exploit_cb)
                exploit_cb(50 * (erase_offset - FLASH_OFF_PS2EXP) / CARD_SIZE);
        }
        exploitprog_wr = 1;

        while (sd_read(fd, buf, sizeof(buf)) == sizeof(buf)) {
            uint32_t ints = save_and_disable_interrupts();
            flash_range_program(offset, buf, sizeof(buf));

            restore_interrupts(ints);
            exploitprog_pos = (CARD_SIZE + offset - FLASH_OFF_PS2EXP) / 2;

            if (exploit_cb)
                exploit_cb(50 + 50 * (offset - FLASH_OFF_PS2EXP) / CARD_SIZE);
            offset += 256;
        }
        exploitprog_wr = -1;
        debug_printf("Wrote new exploit image, took %d s\n", (uint32_t)((time_us_64() - exploitprog_start)/1000000));
    }

    sd_close(fd);
    return 0;
}

void ps2_exploit_set_progress_cb(exploit_cb_t func)
{
    exploit_cb = func;
}


char *ps2_exploit_get_deploy_text(void) {
    static char progress[32];

    snprintf(progress, sizeof(progress), "%s %.2f kB/s", exploitprog_wr == 0 ? "Er" : "Wr", 1000000.0 * exploitprog_pos / (time_us_64() - exploitprog_start) / 1024);

    return progress;
}

bool ps2_exploit_is_available(void) {
    return (*(char *)(FLASH_OFF_PS2EXP + XIP_BASE)) != 0xFF;
}
